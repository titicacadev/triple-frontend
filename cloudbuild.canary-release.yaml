steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    docker pull gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/base || true
    docker pull gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/lint || true
    docker pull gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/build || true
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'build',
    '--cache-from', 'gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/base',
    '--cache-from', 'gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/lint',
    '--cache-from', 'gcr.io/${PROJECT_ID}/${_SVC_BASENAME}/build',
    '--build-arg', 'NPM_TOKEN',
    '--target', 'release',
    '.'
  ]
  secretEnv:
    - 'NPM_TOKEN'

substitutions:
  _SLACK_NOTIFY_CHANNEL: '#triple-web-dev-notifications'
  _SVC_BASENAME: triple-frontend
  _AUTO_TAGGING_ENABLED: 'false'

secrets:
  - kmsKeyName: projects/titicaca-ci/locations/global/keyRings/npm/cryptoKeys/publish_token
    secretEnv:
      NPM_TOKEN: CiQA4RDOWdrx+r3ZCMMAYU+kI/+5cDjDG8W1FVmwUe7lA/hCxSkSTQCM5sIB04ZbQUH3FhF1wC9boXezWZCk3x5YEf3IyXZmOuHbMc+mFf6K1RXZH7HsZTpeb/Go9NVVHpfNplcbxiygv8b2Ewa11h1wkbqZ
